# Render Unified Deployment Guide

This guide will help you deploy both frontend and backend as a **single service** on Render.

## What Changed?

### ‚úÖ Benefits of Unified Deployment:
- **Single service** instead of two (simpler management)
- **No CORS issues** (same domain for frontend and backend)
- **Lower cost** (one service instead of two)
- **Simpler configuration** (no need to set CORS_ORIGIN and VITE_API_URL after deployment)

### üìÅ Files Modified:
1. **`package.json`** (root) - Orchestrates building both frontend and backend
2. **`render.yaml`** - Simplified to single service
3. **`AWI/backend/src/server.js`** - Now serves frontend static files
4. **`AWI/frontend/src/services/api.js`** - Handles same-domain API calls
5. **`AWI/frontend/src/services/uploadService.js`** - Handles same-domain file URLs

## Deployment Steps

### Step 1: Commit and Push Changes

```bash
git add .
git commit -m "Configure unified deployment for Render"
git push origin main
```

### Step 2: Set Up MongoDB Atlas (Free)

1. Go to https://www.mongodb.com/cloud/atlas
2. Sign up and create a **free cluster** (512MB)
3. Create a database user:
   - Click "Database Access" ‚Üí "Add New Database User"
   - Username: `ai-browser-admin`
   - Password: Generate a secure password
4. Whitelist all IPs:
   - Click "Network Access" ‚Üí "Add IP Address"
   - Click "Allow Access from Anywhere" (0.0.0.0/0)
5. Get connection string:
   - Click "Database" ‚Üí "Connect" ‚Üí "Connect your application"
   - Copy the connection string
   - Replace `<password>` with your actual password
   - Example: `mongodb+srv://ai-browser-admin:YOUR_PASSWORD@cluster0.xxxxx.mongodb.net/ai-browser-security?retryWrites=true&w=majority`

### Step 3: Deploy on Render

#### Option A: Blueprint Deployment (Recommended)

1. Go to https://render.com/
2. Sign in with GitHub
3. Click **"New +"** ‚Üí Select **"Blueprint"**
4. Connect your GitHub repository
5. Render will detect `render.yaml`
6. Click **"Apply"**
7. **Add payment info** (required but won't be charged on free tier)

#### Option B: Manual Service Creation

1. Go to https://render.com/
2. Sign in with GitHub
3. Click **"New +"** ‚Üí Select **"Web Service"**
4. Connect your GitHub repository
5. Configure:
   - **Name**: `ai-browser-security`
   - **Root Directory**: Leave empty (uses root)
   - **Build Command**: `npm run build`
   - **Start Command**: `npm start`
   - **Plan**: Free

### Step 4: Configure Environment Variables

After deployment starts, go to your service ‚Üí **Environment** tab:

#### Required (Must Set):
```
MONGODB_URI = <your-mongodb-atlas-connection-string>
```

#### Auto-Configured (Already Set by render.yaml):
```
PORT = 10000
NODE_ENV = production
SESSION_TTL_MINUTES = 30
LIST_CACHE_TTL_MINUTES = 5
MEDIA_CACHE_TTL_MINUTES = 60
BCRYPT_ROUNDS = 10
AWI_MODE_ENABLED = true
AWI_USE_REDIS = false
AWI_MAX_ACTIONS_PER_SESSION = 1000
AWI_CLEANUP_INTERVAL_MINUTES = 60
CORS_ORIGIN = *
ADMIN_DASHBOARD_ENABLED = true
VITE_API_URL =
JWT_SECRET = <auto-generated>
```

### Step 5: Access Your Application

Once deployed, Render will give you a URL like:
```
https://ai-browser-security.onrender.com
```

- **Frontend**: `https://ai-browser-security.onrender.com/`
- **API**: `https://ai-browser-security.onrender.com/api/`
- **Health Check**: `https://ai-browser-security.onrender.com/api/health`
- **API Docs**: `https://ai-browser-security.onrender.com/api/agent/docs/ui`

## How It Works

### Build Process:
1. Render runs `npm run build`
2. This installs dependencies for both backend and frontend
3. Builds the frontend (creates `AWI/frontend/dist`)
4. Backend is ready to start

### Runtime:
1. Render runs `npm start`
2. This starts the Node.js backend server
3. Backend serves API routes at `/api/*`
4. Backend serves frontend static files for all other routes
5. Frontend makes API calls to `/api` (same domain, no CORS)

## Cost Breakdown

With the current free tier setup:
- **Render Web Service (Free)**: 750 hours/month
- **MongoDB Atlas (Free)**: 512MB storage
- **Total**: $0/month üéâ

### Free Tier Limits:
- ‚úÖ 750 hours/month (enough for 1 service running 24/7)
- ‚úÖ Automatic SSL certificate
- ‚úÖ Automatic deploys from GitHub
- ‚ö†Ô∏è Service sleeps after 15 minutes of inactivity (restarts on next request)
- ‚ö†Ô∏è Cold start time: ~30 seconds

## Troubleshooting

### Issue: "Couldn't find package.json"
**Fix**: Make sure `render.yaml` doesn't have a `rootDir` field, or it's set to the repository root.

### Issue: Build fails
**Fix**: Check build logs. Common issues:
- Missing dependencies in root `package.json`
- Node version mismatch (requires Node 18+)

### Issue: Frontend shows "Cannot connect to API"
**Fix**: Check browser console for errors. The API should be at `/api` (relative URL).

### Issue: Database connection failed
**Fix**:
- Verify MongoDB Atlas connection string is correct
- Check that IP whitelist includes 0.0.0.0/0
- Check database user credentials

### Issue: Service keeps sleeping
**Fix**: This is expected on free tier. To prevent sleeping:
- Upgrade to paid tier ($7/month)
- Or use a service like UptimeRobot to ping your app every 5 minutes

## Development vs Production

### Local Development:
```bash
# Terminal 1 - Backend
cd AWI/backend
npm install
npm run dev

# Terminal 2 - Frontend
cd AWI/frontend
npm install
npm run dev
```

Frontend will use `http://localhost:5000/api` for API calls.

### Production (Render):
Both frontend and backend run as a single service on the same domain.

## Updating Your Deployment

Render automatically deploys when you push to your main branch:

```bash
git add .
git commit -m "Your changes"
git push origin main
```

## Next Steps

1. ‚úÖ Test your application at the Render URL
2. ‚úÖ Check `/api/health` endpoint works
3. ‚úÖ Test creating posts, uploading images
4. ‚úÖ Monitor logs in Render dashboard
5. üîí (Optional) Add custom domain
6. üìä (Optional) Set up monitoring/alerts
